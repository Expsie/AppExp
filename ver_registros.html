<script>
  const JSONBIN_CONFIG = {
    binId: 'AQUI_TU_BIN_ID_REAL',
    apiKey: 'AQUI_TU_MASTER_KEY_REAL'
  };

  let allRecords = [];

  function formatFechaISOtoLocal(iso) {
    try { return new Date(iso).toLocaleString('es-ES',{dateStyle:'short', timeStyle:'medium'}); }
    catch { return iso || ''; }
  }

  function renderTable(records) {
    const content = document.getElementById('content');
    if (!records || records.length === 0) {
      content.innerHTML = '<p>No hay registros guardados (array vacío).</p>';
      document.getElementById('export-registros-btn')?.setAttribute('disabled','');
      return;
    }
    let html = '<table id="tabla-registros"><thead><tr>' +
      '<th>Tienda</th><th>Matrícula</th><th>Circuito</th><th>Precinto</th>' +
      '<th>Nº flete</th><th>Fecha creación</th><th>Fecha (línea)</th><th>SSCC</th>' +
    '</tr></thead><tbody>';
    records.forEach(rec => {
      html += `<tr>
        <td>${rec.tienda ?? ''}</td>
        <td>${rec.matricula ?? ''}</td>
        <td>${rec.circuito ?? ''}</td>
        <td>${rec.precinto ?? ''}</td>
        <td>${rec.numeroFlete ?? ''}</td>
        <td>${rec.fechaCreacion ?? ''}</td>
        <td>${rec.fecha ? formatFechaISOtoLocal(rec.fecha) : ''}</td>
        <td>${rec.sscc ?? ''}</td>
      </tr>`;
    });
    html += '</tbody></table>';
    content.innerHTML = html;
    document.getElementById('export-registros-btn')?.removeAttribute('disabled');
  }

  async function loadRecords() {
    const content = document.getElementById('content');
    content.innerHTML = '<p>Cargando registros…</p>';

    if (!JSONBIN_CONFIG.binId || JSONBIN_CONFIG.binId === 'YOUR_BIN_ID') {
      content.innerHTML = '<p>Falta configurar JSONBIN_CONFIG (binId/apiKey).</p>';
      return;
    }

    try {
      const url = `https://api.jsonbin.io/v3/b/${JSONBIN_CONFIG.binId}/latest`;
      const resp = await fetch(url, {
        method: 'GET',
        headers: {
          'X-Master-Key': JSONBIN_CONFIG.apiKey,
          'X-Bin-Meta': 'false'
        }
      });

      if (!resp.ok) {
        const txt = await resp.text();
        console.error('Error HTTP', resp.status, txt);
        content.innerHTML = `<p>Error ${resp.status}: ${txt || resp.statusText}</p>`;
        return;
      }

      const data = await resp.json();
      console.log('Respuesta JSONBin:', data);

      // Acepta ambos formatos: array directo o { record: [] }
      if (Array.isArray(data)) {
        allRecords = data;
      } else if (data && Array.isArray(data.record)) {
        allRecords = data.record;
      } else {
        console.warn('Formato inesperado, intento mostrar tal cual:', data);
        content.innerHTML = `<pre style="white-space:pre-wrap;background:#f7f7f7;padding:10px;border:1px solid #ddd;">${JSON.stringify(data, null, 2)}</pre>`;
        return;
      }

      renderTable(allRecords);

    } catch (err) {
      console.error('Excepción al cargar:', err);
      content.innerHTML = `<p>Error al cargar registros: ${String(err)}</p>`;
    }
  }

  // Si tienes filtros/botón export, vuelve a engancharlos después de esto
  window.addEventListener('DOMContentLoaded', () => {
    document.getElementById('fecha')?.append(
      new Date().toLocaleString('es-ES',{dateStyle:'short', timeStyle:'medium'})
    );
    loadRecords();
  });
</script>
