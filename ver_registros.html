<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Registros SSCC guardados</title>
  <style>
    body{font-family:Arial,sans-serif;margin:20px;}
    h1{text-align:center;}
    table{width:100%;border-collapse:collapse;margin-top:20px;}
    th,td{border:1px solid #ccc;padding:8px;text-align:left;}
    th{background:#f2f2f2;}
    tbody tr:nth-child(odd){background:#fafafa;}
    #filters{margin-bottom:10px;}
    #filters label{display:inline-flex;flex-direction:column;margin-right:12px;font-weight:bold;}
  </style>
</head>
<body>
  <h1>Registros de SSCC guardados</h1>

  <p>Fecha de generación: <span id="fecha"></span></p>

  <!-- Filtros opcionales (puedes dejarlos tal cual) -->
  <div id="filters">
    <label>
      Matrícula (número de camión)
      <input type="text" id="filter-matricula" placeholder="Matrícula">
    </label>
    <label>
      Precinto
      <input type="text" id="filter-precinto" placeholder="Precinto">
    </label>
    <label>
      Fecha (línea)
      <input type="date" id="filter-fecha">
    </label>
    <button id="apply-filters-btn">Aplicar filtros</button>
  </div>

  <button id="export-registros-btn" disabled>Exportar a Excel</button>

  <div id="content"><p>Cargando registros...</p></div>

  <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
  <script>
    // ======= CONFIG JSONBin (mismos valores que en la otra página) =======
    const JSONBIN_CONFIG = {
      binId: 'YOUR_BIN_ID',
      apiKey: 'YOUR_API_KEY'
    };

    let allRecords = [];

    function formatFechaISOtoLocal(iso) {
      try {
        return new Date(iso).toLocaleString('es-ES',{dateStyle:'short', timeStyle:'medium'});
      } catch { return iso || ''; }
    }

    function renderTable(records) {
      if (!records || records.length===0) {
        document.getElementById('content').innerHTML = '<p>No hay registros guardados.</p>';
        document.getElementById('export-registros-btn').disabled = true;
        return;
      }
      // NUEVAS COLUMNAS: Número de flete y Fecha de creación
      let html = '<table id="tabla-registros"><thead><tr>' +
        '<th>Tienda</th><th>Matrícula</th><th>Circuito</th><th>Precinto</th>' +
        '<th>Nº flete</th><th>Fecha creación</th><th>Fecha (línea)</th><th>SSCC</th>' +
      '</tr></thead><tbody>';

      records.forEach(rec=>{
        const fCre = rec.fechaCreacion || '';
        const fLin = rec.fecha ? formatFechaISOtoLocal(rec.fecha) : '';
        html += `<tr>
          <td>${rec.tienda || ''}</td>
          <td>${rec.matricula || ''}</td>
          <td>${rec.circuito || ''}</td>
          <td>${rec.precinto || ''}</td>
          <td>${rec.numeroFlete ?? ''}</td>
          <td>${fCre}</td>
          <td>${fLin}</td>
          <td>${rec.sscc || ''}</td>
        </tr>`;
      });
      html += '</tbody></table>';
      document.getElementById('content').innerHTML = html;
      document.getElementById('export-registros-btn').disabled = false;
    }

    async function loadRecords() {
      if (!JSONBIN_CONFIG.binId || JSONBIN_CONFIG.binId==='YOUR_BIN_ID') {
        document.getElementById('content').innerHTML = '<p>Configura JSONBIN_CONFIG en el código.</p>';
        return;
      }
      document.getElementById('content').innerHTML = '<p>Cargando registros...</p>';
      try {
        const resp = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_CONFIG.binId}/latest`,{
          method:'GET',
          headers:{ 'X-Master-Key': JSONBIN_CONFIG.apiKey, 'X-Bin-Meta': false }
        });
        if (!resp.ok) {
          document.getElementById('content').innerHTML = `<p>Error al obtener registros: ${resp.statusText}</p>`;
          return;
        }
        const data = await resp.json();
        if (Array.isArray(data)) allRecords = data;
        else if (data && Array.isArray(data.record)) allRecords = data.record;
        else allRecords = [];
        // Por defecto: ver TODOS los registros
        renderTable(allRecords);
      } catch(err){
        document.getElementById('content').innerHTML = '<p>Error al cargar registros.</p>';
        console.error(err);
      }
    }

    function applyFilters() {
      const m = document.getElementById('filter-matricula').value.trim().toLowerCase();
      const p = document.getElementById('filter-precinto').value.trim().toLowerCase();
      const f = document.getElementById('filter-fecha').value; // yyyy-mm-dd

      const filtered = allRecords.filter(rec=>{
        const okM = !m || (rec.matricula && rec.matricula.toLowerCase().includes(m));
        const okP = !p || (rec.precinto && rec.precinto.toLowerCase().includes(p));
        let okF = true;
        if (f) {
          const d = rec.fecha ? rec.fecha.substring(0,10) : '';
          okF = (d === f);
        }
        return okM && okP && okF;
      });
      renderTable(filtered);
    }

    function exportCurrentTable(){
      const tableElem = document.getElementById('tabla-registros');
      if (!tableElem) return;
      const wb = XLSX.utils.table_to_book(tableElem,{sheet:'Registros'});
      XLSX.writeFile(wb,'sscc_registros.xlsx');
    }

    window.addEventListener('DOMContentLoaded', ()=>{
      document.getElementById('fecha').textContent =
        new Date().toLocaleString('es-ES',{dateStyle:'short', timeStyle:'medium'});
      loadRecords(); // por defecto, ver todo
      document.getElementById('apply-filters-btn').addEventListener('click', applyFilters);
      document.getElementById('export-registros-btn').addEventListener('click', exportCurrentTable);
    });
  </script>
</body>
</html>
