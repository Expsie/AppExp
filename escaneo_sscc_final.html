<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Registro de SSCC – Captura manual</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.4; }
    h1 { text-align: center; }
    .header-inputs { display:flex; flex-wrap:wrap; gap:15px; margin-bottom:10px; }
    .header-inputs label { display:flex; flex-direction:column; font-weight:bold; }
    .header-inputs input { padding:6px; font-size:1em; }
    button { padding:8px 12px; font-size:1em; margin-right:10px; }
    table { width:100%; border-collapse:collapse; margin-top:20px;}
    th,td { border:1px solid #ccc; padding:8px; text-align:left;}
    th { background:#f2f2f2;}
    tbody tr:nth-child(odd){ background:#fafafa;}
    #debug{white-space:pre-wrap;background:#fff3cd;border:1px solid #ffeeba;padding:10px;margin-top:12px;display:none}
  </style>
</head>
<body>
  <h1>Registro de códigos SSCC – Captura manual</h1>

  <!-- Cabecera -->
  <div class="header-inputs">
    <label>
      Tienda
      <input type="text" id="tienda" placeholder="Código o nombre de la tienda">
    </label>
    <label>
      Matrícula
      <input type="text" id="matricula" placeholder="Matrícula del vehículo">
    </label>
    <label>
      Circuito
      <input type="text" id="circuito" placeholder="Transporte / Retirada ...">
    </label>
    <label>
      Precinto
      <input type="text" id="precinto" placeholder="Número de precinto">
    </label>
    <label>
      SSCC manual
      <input type="text" id="sscc-manual" placeholder="Introduce SSCC manualmente">
    </label>
    <label>
      Número de flete
      <input type="number" id="numero-flete" min="1" step="1" value="1">
    </label>
    <label>
      Fecha de creación
      <input type="date" id="fecha-creacion">
    </label>
  </div>

  <!-- Botones -->
  <button id="export-btn" type="button" disabled>Fin de captura</button>
  <button id="add-manual-btn" type="button" onclick="addManual()">Añadir SSCC manual</button>

  <!-- Tabla -->
  <table id="table">
    <thead>
    <tr>
      <th>Tienda</th>
      <th>Matrícula</th>
      <th>Circuito</th>
      <th>Precinto</th>
      <th>SSCC</th>
      <th>Acciones</th>
    </tr>
    </thead>
    <tbody></tbody>
  </table>

  <pre id="debug"></pre>

  <script>
    // ======= CONFIG REMOTA (JSONBin) =======
    // ⚠️ Esta key es sensible. Para producción, valora ocultarla detrás de un proxy/función serverless.
    const JSONBIN_CONFIG = {
      binId: '68e75f42ae596e708f0b76b0',
      apiKey: '$2a$10$XgjTeUIss3ymiETPPBZyWe40nSYcmT/WCdr8I9YgMGeiONYkisT7W'
      // binId: 'YOUR_BIN_ID', apiKey: 'YOUR_API_KEY'
    };

    // ======= UTIL =======
    function showDebug(msg) {
      const dbg = document.getElementById('debug');
      dbg.textContent = String(msg);
      dbg.style.display = 'block';
    }
    function hideDebug() {
      const dbg = document.getElementById('debug');
      dbg.style.display = 'none';
      dbg.textContent = '';
    }

    // Pone hoy en fecha de creación si está vacía; devuelve yyyy-mm-dd
    function ensureFechaCreacion() {
      const fc = document.getElementById('fecha-creacion');
      if (!fc) return null;
      if (!fc.value) {
        const hoy = new Date();
        const y = hoy.getFullYear();
        const m = String(hoy.getMonth()+1).padStart(2,'0');
        const d = String(hoy.getDate()).padStart(2,'0');
        fc.value = `${y}-${m}-${d}`;
      }
      return fc.value;
    }

    // Añadir fila a la tabla (NO guarda aún)
    function addRow(tienda, matricula, circuito, precinto, sscc) {
      const tbody = document.querySelector('#table tbody');
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${tienda}</td>
        <td>${matricula}</td>
        <td>${circuito}</td>
        <td>${precinto}</td>
        <td>${sscc}</td>
        <td><button type="button" class="delete-row">Eliminar</button></td>
      `;
      row.querySelector('.delete-row').addEventListener('click', () => {
        row.remove();
        if (tbody.children.length === 0) {
          document.getElementById('export-btn').disabled = true;
        }
      });
      tbody.appendChild(row);
      document.getElementById('export-btn').disabled = false;
    }

    // Añadir SSCC manual
    function addManual() {
      try {
        const manualField = document.getElementById('sscc-manual');
        const manualCode  = manualField.value.trim();

        const tiendaVal    = document.getElementById('tienda').value.trim();
        const matriculaVal = document.getElementById('matricula').value.trim();
        const circuitoVal  = document.getElementById('circuito').value.trim();
        const precintoVal  = document.getElementById('precinto').value.trim();

        if (!tiendaVal || !matriculaVal || !circuitoVal || !precintoVal) {
          alert('Completa Tienda, Matrícula, Circuito y Precinto antes de añadir SSCC.');
          return;
        }
        if (!manualCode) {
          alert('Introduce un SSCC.');
          return;
        }

        ensureFechaCreacion();
        addRow(tiendaVal, matriculaVal, circuitoVal, precintoVal, manualCode);
        manualField.value = '';
        manualField.focus();
      } catch (e) {
        console.error('Error en addManual:', e);
        showDebug(e && e.stack ? e.stack : String(e));
        alert('Ocurrió un error al añadir el SSCC. Revisa el recuadro “debug” o la consola (F12).');
      }
    }

    // Recolecta todas las filas visibles de la tabla en objetos de registro
    function collectRowsFromTable() {
      const tienda        = document.getElementById('tienda').value.trim();
      const matricula     = document.getElementById('matricula').value.trim();
      const circuito      = document.getElementById('circuito').value.trim();
      const precinto      = document.getElementById('precinto').value.trim();
      const numeroFlete   = parseInt(document.getElementById('numero-flete').value || '1', 10);
      const fechaCreacion = ensureFechaCreacion(); // yyyy-mm-dd

      const rows = Array.from(document.querySelectorAll('#table tbody tr'));
      const records = rows.map(tr => {
        const tds = tr.querySelectorAll('td');
        const sscc = tds[4]?.textContent?.trim() || '';
        return {
          tienda,
          matricula,
          circuito,
          precinto,
          sscc,
          numeroFlete,
          fechaCreacion,
          fecha: new Date().toISOString()
        };
      });
      return records;
    }

    // Guarda un array de registros en JSONBin (append)
    async function saveBatchToJsonBin(newRecords) {
      if (!newRecords || newRecords.length === 0) return true;

      if (!JSONBIN_CONFIG || !JSONBIN_CONFIG.binId || JSONBIN_CONFIG.binId === 'YOUR_BIN_ID') {
        console.warn('[JSONBin] binId no configurado, no se guarda remoto.');
        return false;
      }
      if (!JSONBIN_CONFIG.apiKey || JSONBIN_CONFIG.apiKey === 'YOUR_API_KEY') {
        console.warn('[JSONBin] apiKey no configurada, no se guarda remoto.');
        return false;
      }

      const apiUrl = `https://api.jsonbin.io/v3/b/${JSONBIN_CONFIG.binId}`;
      let current = [];

      // 1) Lee el contenido actual
      try {
        const getResp = await fetch(`${apiUrl}/latest`, {
          method: 'GET',
          headers: { 'X-Master-Key': JSONBIN_CONFIG.apiKey, 'X-Bin-Meta': 'false' }
        });
        const txt = await getResp.text();
        try {
          const parsed = JSON.parse(txt);
          if (Array.isArray(parsed)) current = parsed;
          else if (parsed && Array.isArray(parsed.record)) current = parsed.record;
          else current = [];
        } catch { current = []; }
      } catch (e) {
        console.warn('[JSONBin] GET latest falló, asumimos []. Detalle:', e);
        current = [];
      }

      // 2) Añade los nuevos registros al final
      current = current.concat(newRecords);

      // 3) PUT (sobrescribe con el array actualizado)
      const putResp = await fetch(apiUrl, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-Master-Key': JSONBIN_CONFIG.apiKey,
          'X-Bin-Versioning': 'false'
        },
        body: JSON.stringify(current)
      });
      if (!putResp.ok) {
        const errTxt = await putResp.text();
        console.error('[JSONBin] PUT error', putResp.status, errTxt);
        showDebug(`PUT error ${putResp.status}:\n${errTxt}`);
        alert(`Error guardando en JSONBin: ${putResp.status}`);
        return false;
      }
      return true;
    }

    // Fin de captura: guarda en bloque + limpia + aumenta flete
    async function finalizarCaptura() {
      try {
        const records = collectRowsFromTable();

        // Si hay filas, guardar en JSONBin
        if (records.length > 0) {
          const ok = await saveBatchToJsonBin(records);
          if (!ok) return; // no limpiar si falló el guardado
        }

        // Incrementa Nº de flete
        const nf = document.getElementById('numero-flete');
        const actual = parseInt(nf.value || '1', 10);
        nf.value = String(actual + 1);

        // Limpia cabecera (menos el Nº de flete, ya incrementado)
        document.getElementById('tienda').value = '';
        document.getElementById('matricula').value = '';
        document.getElementById('circuito').value = '';
        document.getElementById('precinto').value = '';
        document.getElementById('sscc-manual').value = '';
        document.getElementById('fecha-creacion').value = '';

        // Limpia tabla
        const tbody = document.querySelector('#table tbody');
        tbody.innerHTML = '';
        document.getElementById('export-btn').disabled = true;

        hideDebug();
        // alert('Captura guardada y formulario reiniciado.');
      } catch (e) {
        console.error('Error en finalizarCaptura:', e);
        showDebug(e && e.stack ? e.stack : String(e));
        alert('Error en Fin de captura (ver debug/consola).');
      }
    }

    // Al cargar la página
    window.addEventListener('DOMContentLoaded', () => {
      ensureFechaCreacion();

      // Click botón
      const addBtn = document.getElementById('add-manual-btn');
      if (addBtn) addBtn.addEventListener('click', addManual);

      // Enter en input SSCC
      const ssccInput = document.getElementById('sscc-manual');
      if (ssccInput) {
        ssccInput.addEventListener('keydown', (ev) => {
          if (ev.key === 'Enter') {
            ev.preventDefault();
            addManual();
          }
        });
      }

      document.getElementById('export-btn').addEventListener('click', finalizarCaptura);
    });
  </script>
</body>
</html>
