<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de SSCC – Lector mejorado</title>
    <style>
        /* Estilos básicos para mantener la página clara y ordenada */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.4;
        }
        h1 {
            text-align: center;
        }
        .header-inputs {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 10px;
        }
        .header-inputs label {
            display: flex;
            flex-direction: column;
            font-weight: bold;
        }
        .header-inputs input {
            padding: 6px;
            font-size: 1em;
        }
        button {
            padding: 8px 12px;
            font-size: 1em;
            margin-right: 10px;
        }
        #scanner-container {
            width: 100%;
            max-width: 600px;
            margin: 20px auto;
            position: relative;
        }
        #scanner {
            width: 100%;
            border: 2px solid #ddd;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        tbody tr:nth-child(odd) {
            background-color: #fafafa;
        }
    </style>
</head>
<body>
    <h1>Registro de códigos SSCC – Lector mejorado</h1>
    <!-- Entradas de cabecera -->
    <div class="header-inputs">
        <label>
            Tienda
            <input type="text" id="tienda" placeholder="Código o nombre de la tienda">
        </label>
        <label>
            Matrícula
            <input type="text" id="matricula" placeholder="Matrícula del vehículo">
        </label>
        <label>
            Circuito
            <input type="text" id="circuito" placeholder="Circuito o ruta">
        </label>
        <label>
            Precinto
            <input type="text" id="precinto" placeholder="Número de precinto">
        </label>
        <label>
            SSCC manual
            <input type="text" id="sscc-manual" placeholder="Introduce SSCC manualmente">
        </label>
        <label>
            Correo electrónico
            <input type="email" id="correo" placeholder="correo@ejemplo.com">
        </label>
    </div>
    <!-- Botones de control -->
    <button id="start-btn">Iniciar escaneo</button>
    <button id="stop-btn" disabled>Cancelar escaneo</button>
    <button id="export-btn" disabled>Fin de captura (exportar)</button>
    <button id="add-manual-btn">Añadir SSCC manual</button>
    <!-- Contenedor del escáner -->
    <!-- Contenedor del escáner. Se muestra siempre para que el usuario vea dónde irá la cámara -->
    <div id="scanner-container" style="min-height: 300px; border: 2px dashed #ddd; display: block;">
        <div id="scanner" style="width:100%; height:100%;"></div>
    </div>
    <!-- Tabla de resultados -->
    <table id="table">
        <thead>
            <tr>
                <th>Tienda</th>
                <th>Matrícula</th>
                <th>Circuito</th>
                <th>Precinto</th>
                <th>SSCC escaneado</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <!-- Librería Quagga2 para escaneo -->
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@2.0.0/dist/quagga.min.js"></script>
    <!-- Librería SheetJS para exportar los registros -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <!-- Librería SMTPJS para envío de correos electrónicos -->
    <script src="https://smtpjs.com/v3/smtp.js"></script>
    <script>
        // Variables de estado
        let scanning = false;
        // Variables para almacenar valores de cabecera
        let tiendaVal, matriculaVal, circuitoVal, precintoVal;
        // Configuración SMTP opcional
        const SMTP_CONFIG = {
            SecureToken: 'YOUR_SECURE_TOKEN', // Sustituye por tu token de smtpjs.com si lo deseas
            From: 'FROM_ADDRESS'              // Sustituye por tu correo remitente
        };
        // Función para iniciar el escáner con Quagga2
        function startScanner() {
            // Leer y validar campos de cabecera
            tiendaVal = document.getElementById('tienda').value.trim();
            matriculaVal = document.getElementById('matricula').value.trim();
            circuitoVal = document.getElementById('circuito').value.trim();
            precintoVal = document.getElementById('precinto').value.trim();
            if (!tiendaVal || !matriculaVal || !circuitoVal || !precintoVal) {
                alert('Por favor, completa los campos Tienda, Matrícula, Circuito y Precinto antes de escanear.');
                return;
            }
            if (scanning) return;
            const scannerContainer = document.getElementById('scanner-container');
            const scannerElem = document.getElementById('scanner');
            // Mostrar contenedor de escáner
            scannerContainer.style.display = 'block';
            // Configuración de Quagga2
            const quaggaConfig = {
                inputStream: {
                    name: 'Live',
                    type: 'LiveStream',
                    target: scannerElem,
                    constraints: {
                        width: 640,
                        height: 480,
                        facingMode: 'environment'
                    }
                },
                locator: {
                    patchSize: 'medium',
                    halfSample: true
                },
                numOfWorkers: navigator.hardwareConcurrency || 4,
                decoder: {
                    readers: [
                        'code_128_reader',
                        'ean_reader',
                        'ean_8_reader',
                        'code_39_reader',
                        'code_93_reader',
                        'upc_reader',
                        'upc_e_reader',
                        'itf_reader'
                    ]
                },
                locate: true
            };
            Quagga.init(quaggaConfig, function(err) {
                if (err) {
                    console.error(err);
                    alert('Error al iniciar el escáner: ' + err);
                    return;
                }
                Quagga.start();
                scanning = true;
                document.getElementById('start-btn').disabled = true;
                document.getElementById('stop-btn').disabled = false;
                // Procesar detección
                Quagga.onDetected(onDetectedHandler);
            });
        }
        // Manejador de detecciones
        function onDetectedHandler(result) {
            const code = result.codeResult.code;
            if (code) {
                // Añadir la fila con la cabecera y el código detectado
                addRow(tiendaVal, matriculaVal, circuitoVal, precintoVal, code);
                document.getElementById('export-btn').disabled = false;
                // Evitar detecciones duplicadas muy rápidas
                Quagga.offDetected(onDetectedHandler);
                setTimeout(() => {
                    if (scanning) Quagga.onDetected(onDetectedHandler);
                }, 1500);
            }
        }
        // Función para detener el escaneo y liberar la cámara
        function stopScanner() {
            if (!scanning) return;
            Quagga.stop();
            scanning = false;
            document.getElementById('start-btn').disabled = false;
            document.getElementById('stop-btn').disabled = true;
            // Al detener el escaneo, mantenemos visible el contenedor para que el usuario
            // sepa dónde aparece la cámara. Simplemente se detendrá la transmisión.
        }
        // Función para añadir una fila a la tabla
        function addRow(tienda, matricula, circuito, precinto, sscc) {
            const tbody = document.querySelector('#table tbody');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${tienda}</td>
                <td>${matricula}</td>
                <td>${circuito}</td>
                <td>${precinto}</td>
                <td>${sscc}</td>
                <td><button type="button" class="delete-row">Eliminar</button></td>
            `;
            // Asignar evento para eliminar fila
            row.querySelector('.delete-row').addEventListener('click', () => {
                row.remove();
                const tbody = document.querySelector('#table tbody');
                if (tbody.children.length === 0) {
                    document.getElementById('export-btn').disabled = true;
                }
            });
            tbody.appendChild(row);
        }
        // Función para añadir SSCC manualmente
        function addManual() {
            const manualField = document.getElementById('sscc-manual');
            const manualCode = manualField.value.trim();
            const tienda = tiendaVal || document.getElementById('tienda').value.trim();
            const matricula = matriculaVal || document.getElementById('matricula').value.trim();
            const circuito = circuitoVal || document.getElementById('circuito').value.trim();
            const precinto = precintoVal || document.getElementById('precinto').value.trim();
            if (!tienda || !matricula || !circuito || !precinto) {
                alert('Por favor, rellena los campos de cabecera (Tienda, Matrícula, Circuito y Precinto) antes de añadir un SSCC manual.');
                return;
            }
            if (!manualCode) {
                alert('Introduce el código SSCC que deseas añadir manualmente.');
                return;
            }
            addRow(tienda, matricula, circuito, precinto, manualCode);
            document.getElementById('export-btn').disabled = false;
            manualField.value = '';
        }
        // Función para exportar la tabla a Excel y enviar por correo
        function exportTable() {
            if (scanning) {
                stopScanner();
            }
            const tableElem = document.getElementById('table');
            const workbook = XLSX.utils.table_to_book(tableElem, { sheet: 'Expedición' });
            const fileName = 'registro_de_expedicion_LLS_Palma.xlsx';
            XLSX.writeFile(workbook, fileName);
            const correo = document.getElementById('correo').value.trim();
            if (correo) {
                const tokenConfigured = SMTP_CONFIG.SecureToken && SMTP_CONFIG.SecureToken !== 'YOUR_SECURE_TOKEN';
                const fromConfigured = SMTP_CONFIG.From && SMTP_CONFIG.From !== 'FROM_ADDRESS';
                if (tokenConfigured && fromConfigured) {
                    if (confirm(`¿Deseas enviar el fichero Excel automáticamente a ${correo}?`)) {
                        const base64 = XLSX.write(workbook, { bookType: 'xlsx', type: 'base64' });
                        const dataUri = 'data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,' + base64;
                        Email.send({
                            SecureToken: SMTP_CONFIG.SecureToken,
                            To: correo,
                            From: SMTP_CONFIG.From,
                            Subject: 'Registro de expedición LLS Palma',
                            Body: 'Se adjunta el archivo Excel con los registros de expedición.',
                            Attachments: [ { name: fileName, data: dataUri } ]
                        }).then(message => {
                            alert('Correo enviado: ' + message);
                        }).catch(error => {
                            alert('No se pudo enviar el correo automáticamente: ' + error + '\nSe abrirá el cliente de correo predeterminado.');
                            abrirMailto(correo);
                        });
                    } else {
                        abrirMailto(correo);
                    }
                } else {
                    abrirMailto(correo);
                }
            }
        }
        // Función auxiliar para abrir un mailto
        function abrirMailto(correo) {
            const subject = encodeURIComponent('Registro de expedición LLS Palma');
            const body = encodeURIComponent('Adjunto el archivo Excel con los registros de expedición. Por favor, revisa el archivo y confírmame la recepción.');
            const mailtoLink = `mailto:${correo}?subject=${subject}&body=${body}`;
            setTimeout(() => {
                window.location.href = mailtoLink;
            }, 500);
        }
        // Asociar eventos a los botones
        document.getElementById('start-btn').addEventListener('click', startScanner);
        document.getElementById('stop-btn').addEventListener('click', stopScanner);
        document.getElementById('export-btn').addEventListener('click', exportTable);
        document.getElementById('add-manual-btn').addEventListener('click', addManual);
    </script>
</body>
</html>