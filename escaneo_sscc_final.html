<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Registro de SSCC – Captura manual</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.4; }
    h1 { text-align: center; }
    .header-inputs { display:flex; flex-wrap:wrap; gap:15px; margin-bottom:10px; }
    .header-inputs label { display:flex; flex-direction:column; font-weight:bold; }
    .header-inputs input, .header-inputs select { padding:6px; font-size:1em; }
    button { padding:8px 12px; font-size:1em; margin-right:10px; }
    table { width:100%; border-collapse:collapse; margin-top:20px;}
    th,td { border:1px solid #ccc; padding:8px; text-align:left;}
    th { background:#f2f2f2;}
    tbody tr:nth-child(odd){ background:#fafafa;}
  </style>
</head>
<body>
  <h1>Registro de códigos SSCC – Captura manual</h1>

  <!-- Cabecera -->
  <div class="header-inputs">
    <label>
      Tienda
      <input type="text" id="tienda" placeholder="Código o nombre de la tienda">
    </label>
    <label>
      Matrícula
      <input type="text" id="matricula" placeholder="Matrícula del vehículo">
    </label>
    <label>
      Circuito
      <input type="text" id="circuito" placeholder="Circuito o ruta">
    </label>
    <label>
      Precinto
      <input type="text" id="precinto" placeholder="Número de precinto">
    </label>
    <label>
      SSCC manual
      <input type="text" id="sscc-manual" placeholder="Introduce SSCC manualmente">
    </label>
    <!-- NUEVOS CAMPOS -->
    <label>
      Número de flete
      <input type="number" id="numero-flete" min="1" step="1" value="1">
    </label>
    <label>
      Fecha de creación
      <input type="date" id="fecha-creacion">
    </label>
  </div>

  <!-- Botones -->
  <button id="export-btn" type="button" disabled>Fin de captura</button>
  <button id="add-manual-btn" type="button" onclick="addManual()">Añadir SSCC manual</button>

  <!-- Tabla -->
  <table id="table">
    <thead>
    <tr>
      <th>Tienda</th>
      <th>Matrícula</th>
      <th>Circuito</th>
      <th>Precinto</th>
      <th>SSCC</th>
      <th>Acciones</th>
    </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    // ======= CONFIG REMOTA (JSONBin) =======
    // Sustituye con tus credenciales (opcional). Si no usas JSONBin, deja el binId como 'YOUR_BIN_ID' y no fallará la UI.
    const JSONBIN_CONFIG = {
      binId: 'YOUR_BIN_ID',
      apiKey: 'YOUR_API_KEY'
    };

    // ======= UTIL =======
    // Rellena la fecha de creación con hoy si está vacía; devuelve el valor yyyy-mm-dd
    function ensureFechaCreacion() {
      const fc = document.getElementById('fecha-creacion');
      if (!fc) return null;
      if (!fc.value) {
        const hoy = new Date();
        const y = hoy.getFullYear();
        const m = String(hoy.getMonth()+1).padStart(2,'0');
        const d = String(hoy.getDate()).padStart(2,'0');
        fc.value = `${y}-${m}-${d}`;
      }
      return fc.value;
    }

    // Guardar registro en JSONBin (append)
    async function saveRecordToJsonBin(record) {
      if (!JSONBIN_CONFIG.binId || JSONBIN_CONFIG.binId === 'YOUR_BIN_ID') {
        // Sin configuración: no guardamos remoto, pero no rompemos la UI
        return;
      }
      const apiUrl = `https://api.jsonbin.io/v3/b/${JSONBIN_CONFIG.binId}`;
      let currentData = [];
      try {
        const resp = await fetch(`${apiUrl}/latest`, {
          method: 'GET',
          headers: { 'X-Master-Key': JSONBIN_CONFIG.apiKey, 'X-Bin-Meta': false }
        });
        if (resp.ok) {
          const data = await resp.json();
          if (Array.isArray(data)) currentData = data;
          else if (data && Array.isArray(data.record)) currentData = data.record;
        }
      } catch (e) {
        // Si no existe o hay error, empezamos con []
      }
      currentData.push(record);
      const put = await fetch(apiUrl, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-Master-Key': JSONBIN_CONFIG.apiKey,
          'X-Bin-Versioning': 'false'
        },
        body: JSON.stringify(currentData)
      });
      if (!put.ok) {
        console.error('PUT JSONBin falló:', await put.text());
      }
    }

    // Añadir fila y guardar (incluye numeroFlete y fechaCreacion)
    function addRow(tienda, matricula, circuito, precinto, sscc) {
      const tbody = document.querySelector('#table tbody');
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${tienda}</td>
        <td>${matricula}</td>
        <td>${circuito}</td>
        <td>${precinto}</td>
        <td>${sscc}</td>
        <td><button type="button" class="delete-row">Eliminar</button></td>
      `;
      row.querySelector('.delete-row').addEventListener('click', () => {
        row.remove();
        if (tbody.children.length === 0) {
          document.getElementById('export-btn').disabled = true;
        }
      });
      tbody.appendChild(row);

      // Guardado remoto
      const numeroFlete = parseInt(document.getElementById('numero-flete').value || '1', 10);
      const fechaCreacion = ensureFechaCreacion(); // yyyy-mm-dd
      const record = {
        tienda, matricula, circuito, precinto, sscc,
        numeroFlete,
        fechaCreacion,                        // fecha de la cabecera
        fecha: new Date().toISOString()       // timestamp de la línea
      };
      saveRecordToJsonBin(record).catch(err => console.error('Error al guardar en JSONBin:', err));
    }

    // Añadir SSCC manual
    function addManual() {
      try {
        const manualField = document.getElementById('sscc-manual');
        const manualCode  = manualField.value.trim();

        const tiendaVal    = document.getElementById('tienda').value.trim();
        const matriculaVal = document.getElementById('matricula').value.trim();
        const circuitoVal  = document.getElementById('circuito').value.trim();
        const precintoVal  = document.getElementById('precinto').value.trim();

        if (!tiendaVal || !matriculaVal || !circuitoVal || !precintoVal) {
          alert('Completa Tienda, Matrícula, Circuito y Precinto antes de añadir SSCC.');
          return;
        }
        if (!manualCode) {
          alert('Introduce un SSCC.');
          return;
        }

        ensureFechaCreacion();
        addRow(tiendaVal, matriculaVal, circuitoVal, precintoVal, manualCode);
        document.getElementById('export-btn').disabled = false;
        manualField.value = '';
        manualField.focus();
      } catch (e) {
        console.error('Error en addManual:', e);
        alert('Ocurrió un error al añadir el SSCC. Revisa la consola (F12).');
      }
    }

    // Fin de captura: SIN exportar ni correo
    function finalizarCaptura() {
      // 1) Incrementar el número de flete
      const nf = document.getElementById('numero-flete');
      const actual = parseInt(nf.value || '1', 10);
      nf.value = String(actual + 1);

      // 2) Limpiar formulario (excepto número de flete, que ya se incrementó)
      document.getElementById('tienda').value = '';
      document.getElementById('matricula').value = '';
      document.getElementById('circuito').value = '';
      document.getElementById('precinto').value = '';
      document.getElementById('sscc-manual').value = '';

      // 3) Resetear fecha de creación a hoy (nueva captura)
      document.getElementById('fecha-creacion').value = '';

      // 4) Limpiar tabla
      const tbody = document.querySelector('#table tbody');
      tbody.innerHTML = '';
      document.getElementById('export-btn').disabled = true;
    }

    // Al cargar la página
    window.addEventListener('DOMContentLoaded', () => {
      ensureFechaCreacion();
      const addBtn = document.getElementById('add-manual-btn');
      if (addBtn) addBtn.addEventListener('click', addManual);

      const ssccInput = document.getElementById('sscc-manual');
      if (ssccInput) {
        ssccInput.addEventListener('keydown', (ev) => {
          if (ev.key === 'Enter') {
            ev.preventDefault();
            addManual();
          }
        });
      }

      document.getElementById('export-btn').addEventListener('click', finalizarCaptura);
    });
  </script>
</body>
</html>
